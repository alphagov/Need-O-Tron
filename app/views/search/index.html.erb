<div class="filters">
  <% if @filters.present? %>
  <dl class="filter cf">
    <dt>Filter applied:</dt>
    <% @filters.each do |field_name, values| %>
      <dd>
        <% values.each do |value| %>
          <div class="btn">
            <%= link_to "Ã—", search_link_with_removed_filter(params, @filters, field_name => value), class: 'close' %>
            <p><strong><%= t("field.long.#{field_name}") %>:</strong> <%= value %></p>
          </div>
        <% end %>
      </dd>
    <% end %>
  </dl>
  <% end %>
</div>

<div id="needs-content" class="needs-content">
  <% if @search.nothing_found? %>
  <p>Nothing found</p>
  <% else %>
  <table id="needs-table">
    <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Title</th>
        <th scope="col">Format</th>
        <th scope="col">Priority</th>
        <th scope="col">Tags</th>
        <th scope="col">Last updated</th>
        <th scope="col">Created by</th>
        <% if current_user.is_admin? %>
          <th></th>
          <th></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
    <% @search.each_result do |need| %>
      <tr>
        <td>#<%= need.id %></td>
        <th scope="row"><%= link_to need.title, need_path(need.id) %> <% if !params[:in_state] %><small class="status-label <%= need.status %>"><%= status_name need.status %></small><% end %></th>
        <td class="need"><%= need.format_assigned? ? need.kind : "-" %></td>
        <td><%= need.prioritised? ? need.named_priority : '-' %></td>
        <td><%= need.tag_list %></td>
        <td><%= false && time_ago_in_words(need.updated_at, true) %></td>
        <td><%= need.creator %></td>
        <% if current_user.is_admin? %>
        <td><%= link_to 'Edit', edit_need_path(need.id) %></td>
        <td><%= link_to 'Delete', need_path(need.id), confirm: 'Are you sure?', method: :delete %></td>
        <% end %>
      </tr>
    <% end %>
    </tbody>
  </table>
  <% end %>
  <p id="csv-download"><a class="button" href="<%= needs_path(:format => 'csv', :in_state => params[:in_state]) %>">Download as a CSV</a></p>
  <% if current_user.is_admin? %>
  <p id="csv-upload"><%= link_to("Import a CSV with updated data", new_imports_path) %></p>
  <% end %>

  <% if @search.pages.count > 1 %>
  <div class="pagination">
    <ul>
      <%= pagination_link(@current_page - 1, '&larr; Previous'.html_safe, 'prev') %>
      <% @search.pages.each do |page_num| %>
        <%= pagination_link(page_num, page_num) %>
      <% end %>
      <%= pagination_link(@current_page + 1, 'Next &rarr;'.html_safe, 'next') %>
    </ul>
  </div>
  <% end %>

</div>

<div class="search-filters">
  <% if @search.facets %>
  <% @facets.each do |facet| %>
    <h3><span class="visuallyhidden">Filter by</span> <%= t("field.long.#{facet}") %></h3>
    <ul class="filter">
      <% @search.facets[facet].each_slice(2) do |label, count| %>
        <% next if label.blank? %>
        <% if filtering_by?(facet, label) %>
          <li class="filtering">
            <%= label %> (<%= count %>)
            <%= link_to('x', search_link_with_removed_filter(params, @filters, facet => label), class: 'remove') %>
          </li>
        <% else %>
          <li><%= link_to(label, search_link_with_added_filter(params, @filters, facet => label)) %></a> (<%= count %>)</li>
        <% end %>
      <% end %>
    </ul>
  <% end %>
  <% end %>
</div>

</p>
<% content_for :current_state, params[:in_state] %>
